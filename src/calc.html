<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Essential app | Calculator app</title>
    <link rel="stylesheet" href="./css/calc.css" crossorigin="anonymous" />
    <link rel="stylesheet" href="./css/navbar.css" crossorigin="anonymous" />
    <link rel="stylesheet" href="./css/sidebar.css" crossorigin="anonymous" />
    <link rel="stylesheet" href="./css/defaultComp.css" crossorigin="anonymous" />
    <!-- Material icons -->
    <link rel="stylesheet"
        href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:opsz,wght,FILL,GRAD@20..48,100..700,0..1,-50..200" />
    <script>
        // Runtime detection
        (function () {
            const runtime = window.electronAPI ? 'electron' : 'web';
            document.documentElement.setAttribute('data-runtime', runtime);
        })();
        document.documentElement.setAttribute('data-os', window.runtimeInfo.os);
        document.body.classList.add(`os-${window.runtimeInfo.os === 'darwin' ? 'mac' : window.runtimeInfo.os === 'win32' ? 'windows' : 'linux'}`);
    </script>
</head>

<body>

    <!-- import Navbar as <nav> -->

    <!-- <nav id="MainNavbar">
        <div class="contentTEXT">
            <h1>Calculator</h1>
        </div>
        <ul>
            <li id="GotoHomePage"><a href="index.html">
                    <span class="material-symbols-outlined">home</span>
                </a></li>
            <li id="KeepONtop"><a href="javascript:void(0)">
                    <svg xmlns="http://www.w3.org/2000/svg" height="24px" viewBox="0 -960 960 960" width="24px"
                        fill="var(--theme-links)">
                        <path
                            d="M204-129q-30.94 0-52.97-22.03Q129-173.06 129-204v-552q0-30.94 22.03-52.97Q173.06-831 204-831h273v75H204v552h552v-273h75v273q0 30.94-22.03 52.97Q786.94-129 756-129H204Zm185.5-208L337-389.5 703.5-756H552v-75h279v279h-75v-151.5L389.5-337Z" />
                    </svg>
                </a></li>
            <div id="MainLINKS">
                <li><a href="Todolist.html" class="requestShiftkeyHolder">Todo list</a></li>
                <li><a href="Time.html" id="draggable" draggable="true" class="requestShiftkeyHolder">Clock</a></li>
                <li><a href="#" draggable="false" class="requestShiftkeyHolder" id="CurrentPage">Calculator</a></li>
                <li><a href="Notes.html" draggable="false" class="requestShiftkeyHolder">Notes</a></li>
                <li><a href="Paint.html" draggable="false" class="requestShiftkeyHolder">Paint</a></li>
            </div>
        </ul>
    </nav> -->

    <!-- Import Sidebar (menu drawer) -->

    <!-- <div class="menu">
        <div class="menuText">
            <h1>Calculator</h1>
        </div>
        <div class="menuLinks">
            <li id="Current"><a href="javascript:void(0)"><svg xmlns="http://www.w3.org/2000/svg" height="24px"
                        viewBox="0 -960 960 960" width="24px" fill="var(--theme-links)">
                        <path
                            d="M244-204h116v-238.5h240V-204h116v-355L480-736 244-559v355Zm-75 75v-467.5L480-830l311 233.67V-129H525v-238.5h-90V-129H169Zm311-341Z" />
                    </svg>Home</a></li>
            <li><a href="javascript:void(0)"><svg xmlns="http://www.w3.org/2000/svg" height="24px"
                        viewBox="0 -960 960 960" width="24px" fill="var(--theme-links)">
                        <path d="M445-445.5H210v-70h235v-235h70v235h235v70H515v235h-70v-235Z" />
                    </svg>Add list</a></li>
        </div>
        <hr>
        <div class="AllmenuLinks">
            <li><a href="#"><svg xmlns="http://www.w3.org/2000/svg" height="24px" viewBox="0 -960 960 960" width="24px"
                        fill="var(--theme-fg)">
                        <path
                            d="m634-479 78 77v75H517.5v233L480-56l-37.5-38v-233H248v-75l78-77v-278h-40v-75h388v75h-40v278Zm-279 77h250l-46-45v-310H401v310l-46 45Zm125 0Z" />
                    </svg>Planned</a></li>
            <li><a href="#"><svg xmlns="http://www.w3.org/2000/svg" height="24px" viewBox="0 -960 960 960" width="24px"
                        fill="var(--theme-fg)">
                        <path
                            d="M350-281.5 480-360l130 79-34.5-148 115-99-151-13.5-59.5-140L420.5-542l-151 13 115 99.5-34.5 148ZM236.5-125 301-402 86-588l283.5-24.5 110.5-261 110.5 261L874-588 659-402l64.5 277L480-272 236.5-125ZM480-471Z" />
                    </svg>Important</a></li>
            <li><a href="#"><svg xmlns="http://www.w3.org/2000/svg" height="24px" viewBox="0 -960 960 960" width="24px"
                        fill="var(--theme-fg)">
                        <path
                            d="M345-540H205q-30.94 0-52.97-22.03Q130-584.06 130-615v-140q0-30.94 22.03-52.97Q174.06-830 205-830h140q30.94 0 52.97 22.03Q420-785.94 420-755v140q0 30.94-22.03 52.97Q375.94-540 345-540Zm-140-75h140v-140H205v140Zm140 485H205q-30.94 0-52.97-22.03Q130-174.06 130-205v-140q0-30.94 22.03-52.97Q174.06-420 205-420h140q30.94 0 52.97 22.03Q420-375.94 420-345v140q0 30.94-22.03 52.97Q375.94-130 345-130Zm-140-75h140v-140H205v140Zm550-335H615q-30.94 0-52.97-22.03Q540-584.06 540-615v-140q0-30.94 22.03-52.97Q584.06-830 615-830h140q30.94 0 52.97 22.03Q830-785.94 830-755v140q0 30.94-22.03 52.97Q785.94-540 755-540Zm-140-75h140v-140H615v140Zm140 485H615q-30.94 0-52.97-22.03Q540-174.06 540-205v-140q0-30.94 22.03-52.97Q584.06-420 615-420h140q30.94 0 52.97 22.03Q830-375.94 830-345v140q0 30.94-22.03 52.97Q785.94-130 755-130Zm-140-75h140v-140H615v140ZM345-615Zm0 270Zm270-270Zm0 270Z" />
                    </svg>Tasks</a></li>
        </div>

        <div class="bottomCradit">
            <div class="bottomCraditcontent">
                <li class="BottomLinks" id="NewWindow_Settings">
                    <a href="#">
                        <svg xmlns="http://www.w3.org/2000/svg" height="auto" viewBox="0 -960 960 960" width="24px"
                            fill="var(--theme-links)">
                            <path
                                d="m370-80-16-128q-13-5-24.5-12T307-235l-119 50L78-375l103-78q-1-7-1-13.5v-27q0-6.5 1-13.5L78-585l110-190 119 50q11-8 23-15t24-12l16-128h220l16 128q13 5 24.5 12t22.5 15l119-50 110 190-103 78q1 7 1 13.5v27q0 6.5-2 13.5l103 78-110 190-118-50q-11 8-23 15t-24 12L590-80H370Zm70-80h79l14-106q31-8 57.5-23.5T639-327l99 41 39-68-86-65q5-14 7-29.5t2-31.5q0-16-2-31.5t-7-29.5l86-65-39-68-99 42q-22-23-48.5-38.5T533-694l-13-106h-79l-14 106q-31 8-57.5 23.5T321-633l-99-41-39 68 86 64q-5 15-7 30t-2 32q0 16 2 31t7 30l-86 65 39 68 99-42q22 23 48.5 38.5T427-266l13 106Zm42-180q58 0 99-41t41-99q0-58-41-99t-99-41q-59 0-99.5 41T342-480q0 58 40.5 99t99.5 41Zm-2-140Z" />
                        </svg>
                        Settings</a>
                </li>
                <li class="BottomLinks" id="NewWindow_AboutMint">
                    <a href="#">
                        <svg xmlns="http://www.w3.org/2000/svg" height="auto" viewBox="0 -960 960 960" width="24px"
                            fill="var(--theme-links)">
                            <path
                                d="M440-280h80v-240h-80v240Zm40-320q17 0 28.5-11.5T520-640q0-17-11.5-28.5T480-680q-17 0-28.5 11.5T440-640q0 17 11.5 28.5T480-600Zm0 520q-83 0-156-31.5T197-197q-54-54-85.5-127T80-480q0-83 31.5-156T197-763q54-54 127-85.5T480-880q83 0 156 31.5T763-763q54 54 85.5 127T880-480q0 83-31.5 156T763-197q-54 54-127 85.5T480-80Zm0-80q134 0 227-93t93-227q0-134-93-227t-227-93q-134 0-227 93t-93 227q0 134 93 227t227 93Zm0-320Z" />
                        </svg>
                        About this app</a>
                </li>
            </div>
        </div>
    </div> -->

    <!-- <div class="content"> -->

        <div class="calcContainer">
            <div class="calculator">
                <div class="display">
                    <div id="history" style="font-size:28px;color:#aaa;text-align:right;min-height:32px; transform: translateY(15px);"></div>
                    <div id="current"
                        style="min-height:58px; font-size:100px; transition:font-size 0.1s; overflow:hidden; text-overflow:ellipsis; white-space:nowrap; font-family: var(--font-text), sans-serif;">
                        0
                    </div>
                </div>
                <div class="buttons">
                    <button class="special" onclick="clearDisplay()">AC</button>
                    <button class="special" onclick="toggleSign()">±</button>
                    <button class="special" onclick="percentage()">%</button>
                    <button class="operator" onclick="setOperator('÷')">
                        <h1>÷</h1>
                    </button>

                    <button class="number" onclick="appendNumber(7)">7</button>
                    <button class="number" onclick="appendNumber(8)">8</button>
                    <button class="number" onclick="appendNumber(9)">9</button>
                    <button class="operator" onclick="setOperator('×')">
                        <h1>×</h1>
                    </button>

                    <button class="number" onclick="appendNumber(4)">4</button>
                    <button class="number" onclick="appendNumber(5)">5</button>
                    <button class="number" onclick="appendNumber(6)">6</button>
                    <button class="operator" onclick="setOperator('-')">
                        <h1>-</h1>
                    </button>

                    <button class="number" onclick="appendNumber(1)">1</button>
                    <button class="number" onclick="appendNumber(2)">2</button>
                    <button class="number" onclick="appendNumber(3)">3</button>
                    <button class="operator" onclick="setOperator('+')">
                        <h1>+</h1>
                    </button>

                    <button class="number zero" onclick="appendNumber(0)">0</button>
                    <button class="number" onclick="appendDecimal()">.</button>
                    <button class="operator" onclick="calculate()">
                        <h1>=</h1>
                    </button>
                </div>
            </div>
        </div>

    <!-- </div> -->

    <!-- BottomNavbar -->
    <div id="app"></div>

    <script src="renderer.js" defer></script>
    <script src="./frontendJS/PUBLICscripts.js" defer></script>
    <script src="./frontendJS/EssentialAPP_OptionsFeatured.js" defer></script>
    <script src="./Featured/calculator.js"></script>
    <script type="module">
        import { initTheme, listenThemeSync } from './Essential_Pages/Settings_Config/theme.js';
        initTheme();
        listenThemeSync();
    </script>

    <script>

        function formatNumberWithCommas(numStr) {
            // รองรับเลขติดลบและทศนิยม
            if (numStr === '' || numStr === '-') return numStr;
            let [intPart, decPart] = numStr.split('.');
            let sign = '';
            if (intPart.startsWith('-')) {
                sign = '-';
                intPart = intPart.slice(1);
            }
            intPart = intPart.replace(/\B(?=(\d{3})+(?!\d))/g, ",");
            return sign + intPart + (decPart !== undefined ? '.' + decPart : '');
        }

        function fitCurrentFont() {
            const el = document.getElementById('current');
            if (!el) return;

            // Remove transition temporarily for accurate measurement
            const originalTransition = el.style.transition;
            el.style.transition = 'none';

            // Get current font size or start from default
            let fontSize = parseInt(el.style.fontSize) || 80;
            const defaultFontSize = 100;
            const minFontSize = 16;

            // Set initial font size
            el.style.fontSize = fontSize + 'px';

            // If text is overflowing, reduce font size
            if (el.scrollWidth > el.offsetWidth) {
                while (el.scrollWidth > el.offsetWidth && fontSize > minFontSize) {
                    fontSize -= 1;
                    el.style.fontSize = fontSize + 'px';
                }
            }
            // If text fits and current size is less than default, try to increase
            else if (fontSize < defaultFontSize) {
                // Try to increase font size
                let testSize = fontSize;
                while (testSize < defaultFontSize) {
                    testSize += 1;
                    el.style.fontSize = testSize + 'px';

                    // If it overflows at this size, go back to previous size
                    if (el.scrollWidth > el.offsetWidth) {
                        fontSize = testSize - 1;
                        el.style.fontSize = fontSize + 'px';
                        break;
                    }
                    fontSize = testSize;
                }
            }

            // Restore transition
            el.style.transition = originalTransition;
        }

        function updateDisplay() {
            document.getElementById('current').textContent = formatNumberWithCommas(currentNumber);
            let historyText = '';
            if (previousNumber && operation) {
                historyText = formatNumberWithCommas(previousNumber) + ' ' + operation;
            }
            document.getElementById('history').textContent = historyText;
            fitCurrentFont();
        }

        document.addEventListener('keydown', function (e) {
            // Ctrl+C = AC
            if ((e.ctrlKey || e.metaKey) && e.key.toLowerCase() === 'c') {
                clearDisplay();
                e.preventDefault();
                return;
            }
            if (e.key >= '0' && e.key <= '9') {
                appendNumber(Number(e.key));
            } else if (e.key === '.') {
                appendDecimal();
            } else if (e.key === '+' || e.key === '-' || e.key === '*' || e.key === '/') {
                let op = e.key;
                if (op === '*') op = '×';
                if (op === '/') op = '÷';
                setOperator(op);
            } else if (e.key === 'Enter' || e.key === '=') {
                calculate();
            } else if (e.key === '%') {
                percentage();
            } else if (e.key === 'Escape') {
                clearDisplay();
            } else if (e.key.toLowerCase() === 'c') {
                clearDisplay();
            } else if (e.key === 'Backspace') {
                if (currentNumber.length > 1) {
                    currentNumber = currentNumber.slice(0, -1);
                } else {
                    currentNumber = '0';
                }
                updateDisplay();
            }
        });

        // Communicate with parent window
        document.addEventListener('DOMContentLoaded', () => {
            // Notify parent that the app has loaded
            if (window.parent && typeof window.parent.iframeAction === 'function') {
                window.parent.iframeAction('Calculator', 'loaded', { timestamp: new Date() });
            }

            // Listen for commands from the parent window
            window.addEventListener('message', (event) => {
                const { action, data } = event.data;

                if (action === 'clear') {
                    clearDisplay();
                }
            });

            document.addEventListener('keydown', (e) => {
                if (e.ctrlKey || e.metaKey) {
                    if (window.parent) {
                        window.parent.postMessage({
                            action: 'forwardKeydown',
                            key: e.key,
                            code: e.code,
                            ctrlKey: e.ctrlKey,
                            metaKey: e.metaKey,
                            shiftKey: e.shiftKey
                        }, '*');
                    }
                }
            });
        });
    </script>

</body>

</html>