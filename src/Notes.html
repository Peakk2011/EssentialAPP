<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Essential app | Notes apps</title>
    <!-- Set default component -->
    <link rel="stylesheet" href="./CSS/Notes.css" crossorigin="anonymous" />
    <link rel="stylesheet" href="./CSS/Navbar.css" crossorigin="anonymous" />
    <link rel="stylesheet" href="./CSS/Sidebar.css" crossorigin="anonymous" />
    <link rel="stylesheet" href="./CSS/DefaultComp.css" crossorigin="anonymous" />

    <link href="https://api.fontshare.com/v2/css?f[]=general-sans@1,2&f[]=satoshi@1,2&display=swap" rel="stylesheet">
    <!-- Material icons -->
    <link rel="stylesheet"
        href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:opsz,wght,FILL,GRAD@20..48,100..700,0..1,-50..200" />
    <script>
        // Runtime detection
        (function () {
            const runtime = window.electronAPI ? 'electron' : 'web';
            document.documentElement.setAttribute('data-runtime', runtime);
        })();
        document.addEventListener('DOMContentLoaded', () => {
            document.documentElement.setAttribute('data-os', window.runtimeInfo?.os || 'unknown');
            document.body.classList.add(`os-${window.runtimeInfo?.os === 'darwin' ? 'mac' : window.runtimeInfo?.os === 'win32' ? 'windows' : 'linux'}`);
        });
    </script>
    <style>
        body {
            display: flex;
            height: 100vh;
            overflow: hidden;
            background-color: var(--theme-bg);
        }

        .notes-main {
            flex-grow: 1;
            display: flex;
            flex-direction: column;
            width: 100%;
            height: 100%;
        }

        .textarea-container {
            position: relative;
            flex-grow: 1;
            height: 100%;
        }

        #autoSaveTextarea {
            height: 100%;
        }
    </style>
</head>

<body>
    <div class="notes-main">
        <div class="status">
            <div class="dot" id="saveIndicator"></div>
            <span id="statusText">Saved</span>
        </div>

        <div class="textarea-container">
            <textarea id="autoSaveTextarea" placeholder="Select or create a note to start..." spellcheck="false"
                disabled></textarea>

            <div class="zoom-controls">
                <button class="zoom-btn" onclick="zoomOut()">
                    <svg xmlns="http://www.w3.org/2000/svg" height="24px" viewBox="0 -960 960 960" width="24px"
                        fill="currentColor">
                        <path d="M200-440v-80h560v80H200Z" />
                    </svg>
                </button>
                <button class="zoom-btn" onclick="zoomIn()">
                    <svg xmlns="http://www.w3.org/2000/svg" height="24px" viewBox="0 -960 960 960" width="24px"
                        fill="currentColor">
                        <path d="M440-440H200v-80h240v-240h80v240h240v80H520v240h-80v-240Z" />
                    </svg>
                </button>
                <button onclick="resetZoom()" title="Reset" id="reset-zoom"><span>Reset</span></button>
            </div>
        </div>
    </div>

    <script src="./frontendJS/PUBLICscripts.js" defer></script>
    <script>
        // Local zoom functions to fix "not defined" error
        const textareaForZoom = document.getElementById('autoSaveTextarea');
        let currentZoom = 16; // Default font size

        function applyZoom() {
            textareaForZoom.style.fontSize = `${currentZoom}px`;
        }
        function zoomIn() {
            currentZoom = Math.min(48, currentZoom + 2);
            applyZoom();
        }
        function zoomOut() {
            currentZoom = Math.max(8, currentZoom - 2);
            applyZoom();
        }
        function resetZoom() {
            currentZoom = 16;
            applyZoom();
        }
    </script>
    <script type="module">
        import { initTheme, listenThemeSync } from './Essential_Pages/Settings_Config/theme.js';
        initTheme();
        listenThemeSync();

        document.addEventListener('DOMContentLoaded', () => {
            const NOTES_STORAGE_KEY = 'essential_app_note_content'; // Simple key for single note
            const textarea = document.getElementById('autoSaveTextarea');
            let saveTimeout;

            function forceSave() {
                localStorage.setItem(NOTES_STORAGE_KEY, textarea.value);
            }

            textarea.addEventListener('input', () => {
                clearTimeout(saveTimeout);
                saveTimeout = setTimeout(() => {
                    forceSave();
                }, 500);
            });

            // Initial load
            textarea.value = localStorage.getItem(NOTES_STORAGE_KEY) || '';
            textarea.disabled = false;
            textarea.placeholder = "Start writing your notes here...";

            // Parent communication
            function postToParent(action, data = {}) {
                window.parent.postMessage({ appId: 'Note', action, data }, '*'); 
            }

            postToParent('loaded', { timestamp: new Date() });
            
            window.addEventListener('message', (event) => {
                const { action, data } = event.data;

                if (action === 'save') {
                    clearTimeout(saveTimeout);
                    forceSave();
                } else if (action === 'addSelectedToTodo') {
                    const selectedText = textarea.value.substring(textarea.selectionStart, textarea.selectionEnd).trim();
                    if (selectedText) {
                        postToParent('addToTodo', { text: selectedText });
                    }  else {
                        alert('Please select some text in the note to add to your to-do list.');
                    }
                } else if (action === 'focusInput') {
                    textarea.focus();
                }
            });
        });
    </script>
</body>

</html>